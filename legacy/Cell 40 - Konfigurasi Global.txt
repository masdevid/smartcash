# Cell 40 - Konfigurasi Global dengan Layer Config Manager

# Import library yang diperlukan
import os
import yaml
import torch
import numpy as np
from pathlib import Path
import matplotlib.pyplot as plt
from datetime import datetime

# Import utilitas dari SmartCash
from smartcash.utils.logger import SmartCashLogger
from smartcash.utils.layer_config_manager import get_layer_config

# Setup direktori
BASE_DIR = Path.cwd()
CONFIG_DIR = BASE_DIR / "configs"
DATA_DIR = BASE_DIR / "data"
OUTPUT_DIR = BASE_DIR / "runs"

# Pastikan direktori ada
CONFIG_DIR.mkdir(exist_ok=True)
DATA_DIR.mkdir(exist_ok=True)
OUTPUT_DIR.mkdir(exist_ok=True)

# Inisialisasi logger dengan emoji
logger = SmartCashLogger('smartcash')
logger.start("üöÄ Inisialisasi SmartCash")

# Buat konfigurasi default
config = {
    'data_dir': str(DATA_DIR),
    'output_dir': str(OUTPUT_DIR / f"train_{datetime.now().strftime('%Y%m%d_%H%M%S')}"),
    'checkpoints_dir': str(OUTPUT_DIR / "weights"),
    'model': {
        'backbone': 'efficientnet',  # 'efficientnet' atau 'cspdarknet'
        'pretrained': True,
        'img_size': [640, 640],
        'batch_size': 16,
        'memory_limit': 0.7,  # Batas penggunaan memori (0.0-1.0)
        'workers': 4
    },
    'training': {
        'epochs': 30,
        'learning_rate': 1e-4,
        'weight_decay': 5e-4,
        'momentum': 0.937,
        'optimizer': 'adamw',  # 'adam', 'adamw', 'sgd'
        'scheduler': 'cosine',  # 'cosine', 'step', 'plateau'
        'early_stopping_patience': 5,
        'save_every': 5,
        # Augmentasi
        'fliplr': 0.5,
        'flipud': 0.0,
        'hsv_h': 0.015,
        'hsv_s': 0.7,
        'hsv_v': 0.4,
        'degrees': 0.0,
        'translate': 0.1,
        'scale': 0.5
    },
    # Layer yang akan diaktifkan
    'layers': ['banknote']  # ['banknote', 'nominal', 'security']
}

# Simpan konfigurasi ke file
config_path = CONFIG_DIR / f"train_config_{datetime.now().strftime('%Y%m%d_%H%M%S')}.yaml"
with open(config_path, 'w') as f:
    yaml.dump(config, f, default_flow_style=False)

logger.info(f"üìù Konfigurasi disimpan di {config_path}")

# Periksa ketersediaan GPU
if torch.cuda.is_available():
    gpu_info = f"GPU: {torch.cuda.get_device_name(0)}"
    gpu_memory = f"Memory: {torch.cuda.get_device_properties(0).total_memory / 1e9:.2f} GB"
    logger.info(f"üñ•Ô∏è {gpu_info}, {gpu_memory}")
else:
    logger.warning("‚ö†Ô∏è GPU tidak terdeteksi, menggunakan CPU")

# Inisialisasi layer config manager
layer_config = get_layer_config()
active_layers = config['layers']

# Tampilkan informasi layer yang diaktifkan
logger.info(f"üîç Layer yang diaktifkan: {active_layers}")

# Analisis konfigurasi layer
for layer in active_layers:
    layer_info = layer_config.get_layer_config(layer)
    if layer_info:
        class_names = layer_info['classes']
        class_ids = layer_info['class_ids']
        logger.info(f"üìä Layer '{layer}': {len(class_names)} kelas ({', '.join(class_names)})")
    else:
        logger.warning(f"‚ö†Ô∏è Layer '{layer}' tidak ditemukan dalam konfigurasi")

# Jumlah total kelas
total_classes = layer_config.get_total_classes()
logger.info(f"üî¢ Total kelas yang terdeteksi: {total_classes}")

# Function untuk mengupdate konfigurasi
def update_config(param, value):
    """Update parameter konfigurasi."""
    keys = param.split('.')
    current = config
    for key in keys[:-1]:
        if key not in current:
            current[key] = {}
        current = current[key]
    current[keys[-1]] = value
    logger.info(f"üîÑ Parameter '{param}' diupdate: {value}")
    
    # Perbarui file konfigurasi
    with open(config_path, 'w') as f:
        yaml.dump(config, f, default_flow_style=False)
        
    return config

# Function untuk menyesuaikan layer aktif
def set_active_layers(layers):
    """Setel layer yang akan diaktifkan."""
    if not isinstance(layers, list):
        layers = [layers]
        
    # Validasi layer tersedia
    available_layers = layer_config.get_layer_names()
    valid_layers = [layer for layer in layers if layer in available_layers]
    
    if len(valid_layers) != len(layers):
        invalid_layers = set(layers) - set(valid_layers)
        logger.warning(f"‚ö†Ô∏è Layer tidak valid diabaikan: {', '.join(invalid_layers)}")
    
    if not valid_layers:
        logger.warning("‚ö†Ô∏è Tidak ada layer valid, menggunakan 'banknote'")
        valid_layers = ['banknote']
    
    # Update konfigurasi
    config['layers'] = valid_layers
    with open(config_path, 'w') as f:
        yaml.dump(config, f, default_flow_style=False)
    
    logger.info(f"üîÑ Layer aktif diubah: {valid_layers}")
    
    # Perbarui referensi global
    global active_layers
    active_layers = valid_layers
    
    return valid_layers

logger.success("‚úÖ Konfigurasi global siap digunakan")