# Cell 83: Model Playground (refactored) - Untuk mencoba model secara interaktif

import torch
import gc
import pickle
from IPython.display import display

# Import UI components dan handlers
from smartcash.ui_components.model_playground_components import create_model_playground_ui
from smartcash.handlers.ui_handlers.model_playground_handlers import setup_model_playground_handlers

# ===== 1. LOAD MODEL HANDLER & CONFIG =====
# Memuat model_handler dan config dari cell sebelumnya jika tersedia, jika tidak, buat baru
try:
    # Load config
    with open('config.pkl', 'rb') as f:
        config = pickle.load(f)
        
    # Setup logger
    from smartcash.utils.logger import get_logger
    logger = get_logger("model_playground", log_to_console=True)
    
    # Cek apakah model_handler sudah ada
    if 'model_handler' not in globals():
        # Initialize model handler
        from smartcash.handlers.model_handler import ModelHandler
        model_handler = ModelHandler(config=config, logger=logger)
        print("✅ Model handler berhasil dibuat")
except Exception as e:
    print(f"❌ Gagal memuat komponen: {str(e)}")
    # Jika tidak ada komponen yang tersedia, buat placeholder untuk UI demo
    config = {'model': {'backbone': 'efficientnet'}, 'layers': ['banknote']}
    model_handler = None
    logger = None

# ===== 2. BUAT DAN SETUP UI =====
# Buat UI components
ui_components = create_model_playground_ui()

# Setup handlers jika model_handler tersedia
if model_handler and logger:
    setup_model_playground_handlers(
        ui_components=ui_components,
        model_handler=model_handler,
        config=config,
        logger=logger
    )
else:
    print("⚠️ Model handler tidak tersedia. UI akan ditampilkan tapi fungsi tidak akan berjalan.")

# ===== 3. TAMPILKAN UI =====
# Tampilkan UI
display(ui_components['ui'])

# ===== 4. CLEANUP =====
# Bersihkan memori yang tidak digunakan
gc.collect()
torch.cuda.empty_cache() if torch.cuda.is_available() else None