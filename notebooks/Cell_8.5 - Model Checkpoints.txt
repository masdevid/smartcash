# Cell 8.5: Model Checkpoint - Untuk melihat dan mengelola checkpoint model

from datetime import datetime
import ipywidgets as widgets
from IPython.display import display, clear_output
from smartcash.handlers.checkpoint_handler import CheckpointHandler

# Inisialisasi CheckpointHandler
checkpoint_handler = CheckpointHandler()

# Tombol untuk melihat checkpoint
list_checkpoints_button = widgets.Button(
    description='Lihat Checkpoints',
    button_style='info',
    icon='list'
)

cleanup_checkpoints_button = widgets.Button(
    description='Bersihkan Checkpoints',
    button_style='warning',
    icon='trash'
)

# Tambahkan opsi untuk mounting Google Drive
try:
    from google.colab import drive
    drive_mounted = False
    mount_drive_button = widgets.Button(
        description='Mount Google Drive',
        button_style='success',
        icon='folder'
    )
    
    def on_mount_drive_button_clicked(b):
        global drive_mounted
        drive.mount('/content/drive')
        drive_mounted = True
        mount_drive_button.disabled = True
        mount_drive_button.description = 'Google Drive Terpasang'
        mount_drive_button.button_style = ''
        mount_drive_button.icon = 'check'
        
    mount_drive_button.on_click(on_mount_drive_button_clicked)

except ImportError:
    mount_drive_button = None
    drive_mounted = False
    logger.info("‚ÑπÔ∏è Tidak berjalan di Google Colab, opsi Google Drive tidak tersedia")

checkpoints_output = widgets.Output()

def on_list_checkpoints_button_clicked(b):
    with checkpoints_output:
        clear_output()
        checkpoint_handler.display_checkpoints()

def on_cleanup_checkpoints_button_clicked(b):
    with checkpoints_output:
        clear_output()
        
        # Konfirmasi
        print("üßπ Membersihkan checkpoint lama...")
        
        # Jalankan cleanup
        deleted = checkpoint_handler.cleanup_checkpoints(
            keep_best=True,
            keep_latest=True,
            max_epochs=5
        )
        
        # Tampilkan hasil
        if deleted:
            print(f"üöÆ {len(deleted)} checkpoint dihapus:")
            for d in deleted:
                print(f"- {d}")
        else:
            print("‚úÖ Tidak ada checkpoint yang dihapus.")

if drive_mounted or mount_drive_button:
    copy_to_drive_button = widgets.Button(
        description='Salin ke Drive',
        button_style='primary',
        icon='cloud-upload'
    )
    
    drive_path_input = widgets.Text(
        value='/content/drive/MyDrive/SmartCash/weights',
        description='Path di Drive:',
        style={'description_width': 'initial'},
        layout={'width': '400px'}
    )
    
    def on_copy_to_drive_button_clicked(b):
        with checkpoints_output:
            clear_output()
            
            if not drive_mounted and mount_drive_button:
                print("‚ö†Ô∏è Google Drive belum terpasang. Silakan klik tombol 'Mount Google Drive' terlebih dahulu.")
                return
                
            # Dapatkan checkpoint terbaik
            best_checkpoint = checkpoint_handler.find_best_checkpoint()
            if not best_checkpoint:
                print("‚ö†Ô∏è Tidak ada checkpoint yang ditemukan.")
                return
            
            # Salin ke Google Drive
            print(f"üì§ Menyalin checkpoint terbaik ke Google Drive...")
            checkpoint_handler.copy_to_drive(best_checkpoint, drive_path_input.value)
            print("‚úÖ Berhasil menyalin checkpoint ke Google Drive.")
    
    copy_to_drive_button.on_click(on_copy_to_drive_button_clicked)

# Tampilkan UI
ui_components = [
    widgets.HTML("<h2>üì¶ Pengelolaan Checkpoint</h2>"),
    widgets.HTML("<p>Kelola checkpoint model yang tersimpan di sistem.</p>"),
    widgets.HBox([list_checkpoints_button, cleanup_checkpoints_button])
]

if mount_drive_button:
    ui_components.append(widgets.HTML("<h3>üîÑ Google Drive Integration</h3>"))
    ui_components.append(widgets.VBox([
        mount_drive_button,
        widgets.HBox([drive_path_input, copy_to_drive_button]) if 'copy_to_drive_button' in locals() else None
    ]))
    ui_components.append(widgets.HTML("<p><i>Mount Google Drive untuk menyimpan checkpoint secara permanen</i></p>"))

ui_components.append(checkpoints_output)

display(widgets.VBox([comp for comp in ui_components if comp is not None]))

# Tampilkan daftar checkpoint awal
with checkpoints_output:
    checkpoint_handler.display_checkpoints()